@model DLDA.GUI.DTOs.StaffResultOverviewDto
@{
    ViewData["Title"] = "Resultatöversikt";
    var isLocked = Model.IsStaffComplete;
}

@functions {
    string FormatAnswer(int? value) => value switch
    {
        0 => "Inget problem<br /><small class=\"text-muted\">(0)</small>",
        1 => "Litet problem<br /><small class=\"text-muted\">(1)</small>",
        2 => "Måttligt problem<br /><small class=\"text-muted\">(2)</small>",
        3 => "Stort problem<br /><small class=\"text-muted\">(3)</small>",
        4 => "Mycket stort problem<br /><small class=\"text-muted\">(4)</small>",
        _ => "Ej besvarad"
    };

    string GetRowColor(int difference, bool skipped)
    {
        if (skipped) return "table-danger";
        if (difference == 0) return "table-success";
        if (difference == 1) return "table-warning";
        if (difference > 1) return "table-danger";
        return "";
    }
}

<div class="mt-4 d-flex gap-3">
    <a class="btn btn-outline-secondary"
       asp-controller="StaffAssessment"
       asp-action="Assessments"
       asp-route-userId="@Model.UserId">
        ⬅ Tillbaka till patientens bedömningar
    </a>

    @if (!Model.IsStaffComplete)
    {
        <form asp-action="Complete" method="post">
            <input type="hidden" name="assessmentId" value="@Model.AssessmentId" />
            <input type="hidden" name="userId" value="@Model.UserId" />
            <button type="submit" class="btn btn-success">
                ✔️ Markera personalbedömning som klar
            </button>
        </form>
    }
</div>

<div class="container mt-5">
    <h2>Sammanställning av personalens bedömning</h2>

    @{
        var countMatch = Model.Questions.Count(q => q.Difference == 0);
        var countMinor = Model.Questions.Count(q => q.Difference == 1 && !q.SkippedByPatient);
        var countMajor = Model.Questions.Count(q => q.Difference > 1);
        var countSkipped = Model.Questions.Count(q => q.SkippedByPatient);
    }

    <div class="mt-3">
        <h5>Sammanfattning</h5>
        <ul>
            <li><span class="badge bg-success">Grön:</span> Matchande svar: <strong>@countMatch</strong></li>
            <li><span class="badge bg-warning text-dark">Gul:</span> Viss skillnad (1 steg): <strong>@countMinor</strong></li>
            <li><span class="badge bg-danger">Röd:</span> Tydlig skillnad (>1 steg): <strong>@countMajor</strong></li>
            <li><span class="badge bg-danger">Röd:</span> Patient hoppade över: <strong>@countSkipped</strong></li>
        </ul>
    </div>

    <p><strong>Bedömning ID:</strong> @Model.AssessmentId</p>
    <p><strong>Patient:</strong> @Model.Username</p>
    <p><strong>Datum:</strong> @Model.CreatedAt.ToString("yyyy-MM-dd")</p>

    @if (isLocked)
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">
                🔒 Denna bedömning är markerad som klar och kan inte längre redigeras.
            </span>
            <form asp-action="Unlock" method="post" class="mb-0">
                <input type="hidden" name="assessmentId" value="@Model.AssessmentId" />
                <input type="hidden" name="userId" value="@Model.UserId" />
                <button type="submit" class="btn btn-outline-danger btn-sm ms-3">
                    🔓 Lås upp
                </button>
            </form>
        </div>
    }

    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Fråga</th>
                <th>Patientens svar</th>
                <th>Personalens svar</th>
                <th>Skillnad</th>
                <th>Flagga</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var q in Model.Questions.OrderBy(q => q.Order))
            {
                <tr id="row_@q.ItemID" class="@GetRowColor(q.Difference, q.SkippedByPatient)">
                    <form asp-controller="StaffResult"
                          asp-action="UpdateStaffAnswer"
                          method="post">
                        <input type="hidden" name="itemId" value="@q.ItemID" />
                        <input type="hidden" name="assessmentId" value="@Model.AssessmentId" />

                    <td>@(q.Order + 1)</td>
                    <td>
                        @q.QuestionText
                        <div class="text-muted small mt-1">
                            <strong>Kommentar (patient):</strong><br />
                            @(string.IsNullOrWhiteSpace(q.PatientComment) ? "Ingen kommentar" : q.PatientComment)
                        </div>
                    </td>
                    <td>@Html.Raw(FormatAnswer(q.PatientAnswer))</td>
                    <td>
                        <div class="d-flex gap-1 flex-wrap">
                            @for (int i = 0; i <= 4; i++)
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input"
                                           type="radio"
                                           name="answer"
                                           id="answer_@q.ItemID@i"
                                           value="@i"
                                           @(q.StaffAnswer == i ? "checked" : "")
                                           @(isLocked ? "disabled" : "")
                                           onchange="rememberScroll('row_@q.ItemID'); this.form.submit()" />
                                    <label class="form-check-label" for="answer_@q.ItemID@i">@i</label>
                                </div>
                            }
                        </div>
                        <textarea name="comment"
                              class="form-control form-control-sm mt-1"
                              rows="2"
                              placeholder="Kommentar (frivilligt)"
                              @(isLocked ? "disabled" : "")
                              onchange="rememberScroll('row_@q.ItemID'); this.form.submit()">@q.StaffComment</textarea>
                        @if (q.StaffAnswer.HasValue)
                        {
                            <div class="mt-1 small text-muted">
                                <strong>Valt:</strong><br />
                                @Html.Raw(FormatAnswer(q.StaffAnswer))
                            </div>
                        }
                    </td>
                    <td>@(q.Difference >= 0 ? q.Difference.ToString() : "-")</td>
                    <td class="text-center">
                        <input type="checkbox"
                               name="flag"
                               id="flag_@q.ItemID"
                               value="true"
                               class="form-check-input"
                               @(q.Flag ? "checked" : "")
                               @(isLocked ? "disabled" : "")
                               onchange="rememberScroll('row_@q.ItemID'); this.form.submit()" />
                    </td>
                    </form>
                </tr>
            }
        </tbody>
    </table>
</div>

<a class="btn btn-outline-secondary"
   asp-controller="StaffAssessment"
   asp-action="Assessments"
   asp-route-userId="@Model.UserId">
    ⬅ Tillbaka till patientens bedömningar
</a>
